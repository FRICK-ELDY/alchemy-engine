//! Path: native/game_physics/src/world/game_world.rs
//! Summary: ゲームワールド（GameWorldInner, GameWorld）

use super::{BossState, BulletWorld, EnemyWorld, ParticleWorld, PlayerState};
use crate::entity_params::EntityParamTables;
use crate::item::ItemWorld;
use crate::physics::rng::SimpleRng;
use crate::physics::spatial_hash::CollisionWorld;
use crate::weapon::WeaponSlot;
use std::sync::RwLock;

use super::FrameEvent;

/// ???????????
///
/// ## Elixir as SSoT ??????
/// ????????? Elixir ????????????? NIF ??????:
/// - `player.hp`        ? set_player_hp NIF?????2?
/// - `player.input_dx/dy` ? set_player_input NIF?????5?
/// - `elapsed_seconds`  ? set_elapsed_seconds NIF?????3?
/// - `boss.hp`          ? set_boss_hp NIF?????4?
/// - `score`, `kill_count` ? set_hud_state NIF?????1?
/// - `params`           ? set_entity_params NIF?Phase 3-A?
/// - `map_width/height` ? set_world_size NIF?Phase 3-A?
/// - `hud_level`, `hud_exp`, `hud_exp_to_next`, `hud_level_up_pending`, `hud_weapon_choices`
///                      ? set_hud_level_state NIF?Phase 3-B: ?????
/// - `weapon_slots`     ? set_weapon_slots NIF?I-2: ????? Elixir ?????
pub struct GameWorldInner {
    pub frame_id:           u32,
    pub player:             PlayerState,
    pub enemies:            EnemyWorld,
    pub bullets:            BulletWorld,
    pub particles:          ParticleWorld,
    /// 1.2.4: ????
    pub items:              ItemWorld,
    /// ??????????????
    pub magnet_timer:       f32,
    pub rng:                SimpleRng,
    pub collision:          CollisionWorld,
    /// 1.5.2: ?????????????????????
    pub obstacle_query_buf: Vec<usize>,
    /// ??????????????????????????????????????????
    pub spatial_query_buf:  Vec<usize>,
    /// ??????????????????????
    pub last_frame_time_ms: f64,
    /// ???????????????- Elixir ??????????????????
    pub elapsed_seconds:    f32,
    /// ???????? HP?HP ??????
    pub player_max_hp:      f32,
    /// I-2: ??????????????????????- Elixir ??????? set_weapon_slots NIF ???
    pub weapon_slots:       Vec<WeaponSlot>,
    /// I-2: ???????????boss.hp ? Elixir ??????????
    /// ???????? Elixir ? Rule state ??????
    pub boss:               Option<BossState>,
    /// 1.3.1: ????????????????????? drain ????
    pub frame_events:       Vec<FrameEvent>,
    /// 1.7.5: ????????? [(world_x, world_y, value, lifetime)]?????
    pub score_popups:       Vec<(f32, f32, u32, f32)>,
    /// ??? - Elixir ??????????HUD ????
    pub score:              u32,
    /// ??? - Elixir ??????????HUD ????
    pub kill_count:         u32,
    /// 1.10.7: ??? - ?????????????
    pub prev_player_x:      f32,
    pub prev_player_y:      f32,
    /// 1.10.7: ??? - ????????????????ms?
    pub prev_tick_ms:       u64,
    /// 1.10.7: ??? - ?????????????????ms?
    pub curr_tick_ms:       u64,
    /// Phase 3-A: ????????????????set_entity_params NIF ????
    pub params:             EntityParamTables,
    /// Phase 3-A: ???????set_world_size NIF ????
    pub map_width:          f32,
    pub map_height:         f32,
    /// Phase 3-B: HUD ??????????Elixir SSoT ??????????
    /// ???????????????????????????????????
    pub hud_level:              u32,
    pub hud_exp:                u32,
    pub hud_exp_to_next:        u32,
    pub hud_level_up_pending:   bool,
    pub hud_weapon_choices:     Vec<String>,
}

impl GameWorldInner {
    /// ?????? Spatial Hash ???????clone ???
    pub fn rebuild_collision(&mut self) {
        self.collision.dynamic.clear();
        self.enemies.alive
            .iter()
            .enumerate()
            .filter(|&(_, &is_alive)| is_alive != 0)
            .for_each(|(i, _)| {
                self.collision.dynamic.insert(
                    i,
                    self.enemies.positions_x[i],
                    self.enemies.positions_y[i],
                );
            });
    }
}

/// ????????RwLock ???????????
pub struct GameWorld(pub RwLock<GameWorldInner>);

#[cfg(feature = "nif")]
impl rustler::Resource for GameWorld {}

#[cfg(feature = "nif")]
impl rustler::Resource for super::game_loop_control::GameLoopControl {}
