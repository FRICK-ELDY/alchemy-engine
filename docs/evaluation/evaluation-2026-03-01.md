# AlchemyEngine — プロジェクト総合評価レポート

**評価日**: 2026-03-01（第2回）
**評価者**: Cursor AI Agent（claude-4.6-sonnet-high）
**対象**: コードベース全体（Elixir umbrella アプリ群 + Rust ネイティブクレート群 + ドキュメント）
**前回評価**: 2026-03-01 早朝（第1回、+55点）

> 採点基準: +1（正しい）/ +2（良い判断）/ +3（平均を上回る）/ +4（プロダクション水準）/ +5（個人プロジェクトで見たことがない）
> 　　　　　-1（軽微）/ -2（拡張を阻害）/ -3（バグ・クラッシュを引き起こしうる）/ -4（価値命題を損なう）/ -5（根幹を揺るがす致命的欠陥）

---

## エグゼクティブサマリー

AlchemyEngine は前回評価（+55点）から大幅に改善された。最大の変化は **ネットワーク層の完全実装**（`GameNetwork.Local` + Phoenix Channels + UDP）、**GitHub Actions CI パイプラインの追加**、**バックプレッシャー機構の実装**（IP-04）、**GameEvents リファクタリング**（697行→426行）、**ヘッドレスレンダラーの実装**（IP-05）の5点である。

これらの改善により、「なぜ Elixir か」という問いに対してコードが初めて答えられるようになった。`GameNetwork.Local` の OTP 隔離テスト（一方のルームがクラッシュしても他方が継続する）が実証されており、Phoenix Channels と UDP トランスポートも実装済みである。

残る主要課題は **Elixir コアモジュールのテスト不足**（`GameEvents` / `SceneManager` / `EventBus` のテストがゼロ）、**複数ルームの実動作未実証**、および **描画層の技術的負債**（UV マジックナンバー・毎フレームアロケーション）である。

---

## 観点別採点

---

### 1. Elixir の真価

| 項目 | 点数 |
|:---|:---:|
| `:one_for_one` Supervisor ツリーの正しい構成 | +2 |
| DynamicSupervisor + Registry による複数ルーム先行設計 | +3 |
| `StressMonitor` が独立プロセスとして存在する | +2 |
| 5 つの独立 GenServer による責務分離 | +3 |
| `ContentBehaviour` によるコンテンツ完全交換（2コンテンツ実証済み） | +5 |
| `Component` ビヘイビアのオプショナルコールバック設計 | +2 |
| `SceneBehaviour` 遷移戻り値の型安全設計 | +2 |
| Elixir as SSoT フェーズ1〜5の完遂 | +4 |
| ボス AI ロジックが Elixir 側に存在（SSoT 最難関の適用） | +4 |
| `:telemetry` による観測性 | +2 |
| **[NEW] バックプレッシャー機構（IP-04）** — メールボックス深度監視 | **+4** |
| **[NEW] `GameNetwork.Local` による OTP 隔離実証** | **+4** |
| **[NEW] Phoenix Channels / WebSocket トランスポート実装** | **+3** |
| **[NEW] UDP トランスポート実装** | **+3** |
| **[NEW] UDP プロトコルのバイナリパターンマッチ** | **+3** |
| `GameEvents`（426行）のテストがゼロ | **-3** |
| `SceneManager` / `EventBus` / 全シーンのテストがゼロ | **-2** |
| `create_world()` NIF が `NifResult` を返さない | **-2** |
| NIF バージョニング・ABI 互換性チェックがない | **-2** |
| 複数ルームの同時起動が実証されていない | **-2** |
| WebSocket 認証が未実装 | **-2** |
| ラグ補償・ロールバック netcode がない | **-2** |
| NIF パニック後のゲームループ再起動ロジックが存在しない | **-2** |

**小計: +46 / -17 = +29点**（前回 +5点 → **+24点改善**）

> ネットワーク層の実装により、Elixir を選んだ根拠がコードとして証明された。バックプレッシャー機構は精緻な実装。残る最大課題はテスト不足。

---

### 2. Rust の真価

| 項目 | 点数 |
|:---|:---:|
| 全エンティティ種別の完全 SoA ECS 設計 | +4 |
| `free_list` による O(1) スポーン/キル | +3 |
| SSE2 SIMD 4体並列 Chase AI | +4 |
| `alive_mask` による死亡敵の速度フィールド保護 | +4 |
| SIMD / rayon / スカラーの 3 段階適応戦略 | +3 |
| SIMD/スカラー一致テストの存在 | +4 |
| `FxHashMap` 空間ハッシュによる O(n) 衝突検出 | +4 |
| LCG 決定論的乱数（リプレイ/同期の基盤） | +5 |
| `ResourceArc` による Elixir GC 連動ライフタイム管理 | +5 |
| RwLock 競合時間の閾値監視（300μs / 500μs） | +3 |
| `game_physics` の依存が 3 クレートのみ | +3 |
| **[NEW] ヘッドレスレンダラー（IP-05）** — wgpu オフスクリーン描画 | **+4** |
| SIMD パスが x86_64 専用（ARM NEON なし） | **-2** |
| WASM / `#[no_std]` への準備がゼロ | **-2** |
| スプライトアトラス UV がマジックナンバーで散在 | **-2** |
| Ghost・Skeleton の UV が `TODO` プレースホルダー | **-2** |
| 毎フレーム `Vec` アロケーション（描画インスタンス） | **-2** |
| レンダーグラフ・明示的パス依存宣言がない | **-2** |
| フラスタムカリングがない | **-2** |
| egui HUD ロジックがレンダリングバックエンドと結合 | **-2** |
| ボイスリミット・優先度システムがない | **-2** |
| BGM ファイルがリポジトリに存在しない | **-2** |
| 空間オーディオが未実装 | **-1** |

**小計: +46 / -21 = +25点**（前回 +26点 → **-1点**）

> ヘッドレスレンダラーの追加が +4点だが、描画層の技術的負債（毎フレームアロケーション・UV マジックナンバー）が新たに詳細評価されてわずかに減点。Rust 実装の核心部は依然プロダクション水準。

---

### 3. Elixir × Rust 連携の真価

| 項目 | 点数 |
|:---|:---:|
| NIF 関数の 5 カテゴリ分類（ロック競合の予測可能性） | +5 |
| 60Hz Rust ループ → `OwnedEnv::send_and_clear` → Elixir | +3 |
| パラメータ注入パターン（Rust にゲームバランス値なし） | +5 |
| `NifBridgeBehaviour` + Mox による NIF モック | +4 |
| NIF バージョニング・ABI 互換性チェックがない | **-2** |
| `set_hud_state` が毎フレーム write lock を取得 | **-1** |
| Rust → Elixir メールボックスへのバックプレッシャーがない（Rust 側） | **-1** |
| `decode_fire_pattern` のサイレントフォールバック | **-1** |

**小計: +17 / -5 = +12点**（前回 +11点 → **+1点改善**）

> IP-04 バックプレッシャーの Elixir 側実装で -3 → -1 に改善。連携設計の思想的正しさは変わらず。

---

### 4. 物理層

| 項目 | 点数 |
|:---|:---:|
| 7 種の `FirePattern`（正確な幾何学計算） | +4 |
| 障害物押し出し最大 5 回反復（収束保証） | +2 |
| 敵分離アルゴリズム | +2 |
| ボス速度・タイマーの Elixir 注入（SSoT 最難関） | +4 |
| ARM NEON の SIMD 実装がない | **-2** |
| 広域フェーズに BVH / AABB ツリーがない | **-2** |
| 物理ステップ実行順序が暗黙的でドキュメントがない | **-1** |

**小計: +12 / -5 = +7点**（前回 +6点 → **+1点改善**）

> 物理ステップ順序の暗黙性が -2 → -1 に軽微改善（コードの可読性向上）。

---

### 5. 描画層

| 項目 | 点数 |
|:---|:---:|
| wgpu インスタンス描画（最大 14,502 エントリ） | +3 |
| サブフレーム補間（lerp）がロック外で計算される | +4 |
| WGSL スプライトシェーダー（レガシー GLSL なし） | +2 |
| **[NEW] ヘッドレスレンダラー（IP-05）** — CI 対応 | **+4** |
| レンダーグラフ・明示的パス依存宣言がない | **-2** |
| フラスタムカリングがない | **-2** |
| egui HUD ロジックがレンダリングバックエンドと結合 | **-2** |
| 毎フレーム `Vec` アロケーション | **-2** |

**小計: +13 / -8 = +5点**（前回 0点 → **+5点改善**）

> ヘッドレスレンダラーの追加が大きなプラス。CI でのレンダリング回帰テストが可能になった。

---

### 6. オーディオ層

| 項目 | 点数 |
|:---|:---:|
| コマンドパターン + `mpsc::channel` 完全非同期 | +3 |
| デバイス不在時のグレースフルフォールバック | +4 |
| 4 段階フォールバックのアセット探索 | +2 |
| 空間オーディオが未実装 | **-1** |
| ボイスリミット・優先度システムがない | **-2** |
| BGM ファイルがリポジトリに存在しない | **-2** |

**小計: +9 / -5 = +4点**（前回 +4点 → **変化なし**）

> アーキテクチャは正しく、フォールバック設計はプロダクション品質。コンテンツの充実度が低い状況は変わらず。

---

### 7. コンポーネント層

| 項目 | 点数 |
|:---|:---:|
| Unity 相当のライフサイクルコールバック | +3 |
| シーンスタック（push / pop / replace）完全実装 | +3 |
| `pause_on_push?/1` によるシーン別ポーズ制御 | +2 |
| `on_physics_process` が実質 `on_process` と同一レート | **-1** |
| コンポーネント依存性注入・サービスロケーターがない | **-2** |

**小計: +8 / -3 = +5点**（前回 +5点 → **変化なし**）

---

### 8. ネットワーク層

| 項目 | 点数 |
|:---|:---:|
| DynamicSupervisor + Registry アーキテクチャが先行実装済み | +2 |
| 決定論的 LCG 乱数（ロックステップ同期の正しい基盤） | +2 |
| **[NEW] `GameNetwork.Local` 完全実装（275行）** | **+4** |
| **[NEW] Phoenix Channels / WebSocket トランスポート実装（159行）** | **+3** |
| **[NEW] UDP トランスポート実装（263行）** | **+3** |
| **[NEW] OTP 隔離テスト（StubRoom を使用した実証）** | **+3** |
| 複数ルームの同時起動が実証されていない | **-2** |
| WebSocket 認証が未実装 | **-2** |
| ラグ補償・ロールバック netcode がない | **-2** |

**小計: +17 / -6 = +11点**（前回 -11点 → **+22点改善**）

> 前回評価で最大の失点だったネットワーク層が大幅改善。`game_network.ex` が完全実装され、Elixir を選んだ根拠が証明された。

---

### 9. ユーザー層

| 項目 | 点数 |
|:---|:---:|
| HMAC 署名付きセーブデータ | +3 |
| 上位 10 件ハイスコア管理 | +1 |
| ゲーム内設定 UI がない | **-2** |
| セーブ形式が Erlang バイナリ term（非ポータブル） | **-2** |
| 決定論的乱数があるにもかかわらずリプレイが未実装 | **-1** |

**小計: +4 / -5 = -1点**（前回 -1点 → **変化なし**）

---

### 10. プロジェクト全体設計

| 項目 | 点数 |
|:---|:---:|
| 11 ファイル・約 1,500 行のドキュメント（Mermaid 図付き） | +5 |
| 自己認識的な弱点管理（improvement-plan / pending-issues） | +3 |
| Umbrella プロジェクトによるアプリ境界の明確化 | +2 |
| Rust ワークスペース + `"nif"` フィーチャーフラグ | +2 |
| `game_content` 純粋関数テストが `async: true` で並列実行可能 | +2 |
| Rust `chase_ai.rs` の充実した単体テスト | +4 |
| **[NEW] GitHub Actions CI パイプライン（5 ジョブ）** | **+4** |
| **[NEW] ローカル CI スクリプト（`bin/ci.bat`）** | **+2** |
| **[NEW] ベンチマーク回帰チェック（main ブランチ、+10% 劣化でブロック）** | **+3** |
| `visual-editor-architecture.md` が存在しないシステムを記述 | **-1** |
| `improvement-plan.md` の完了済み項目アーカイブ先が未作成 | **-1** |
| Elixir → Rust フルラウンドトリップのベンチマークがない | **-2** |
| `LevelComponent` のアイテムドロップ重複ロジック（潜在バグ） | **-3** |
| プロセス辞書によるダーティフラグ管理（テスト困難） | **-1** |

**小計: +27 / -8 = +19点**（前回 +10点 → **+9点改善**）

> CI/CD の追加とベンチマーク回帰チェックが大きなプラス。アイテムドロップ重複バグが新たに発見され -3点。

---

## 総合スコア

| 観点 | プラス | マイナス | 小計 | 前回差分 |
|:---|:---:|:---:|:---:|:---:|
| 1. Elixir の真価 | +46 | -17 | **+29** | +24 ↑ |
| 2. Rust の真価 | +46 | -21 | **+25** | -1 ↓ |
| 3. Elixir × Rust 連携 | +17 | -5 | **+12** | +1 ↑ |
| 4. 物理層 | +12 | -5 | **+7** | +1 ↑ |
| 5. 描画層 | +13 | -8 | **+5** | +5 ↑ |
| 6. オーディオ層 | +9 | -5 | **+4** | 0 |
| 7. コンポーネント層 | +8 | -3 | **+5** | 0 |
| 8. ネットワーク層 | +17 | -6 | **+11** | +22 ↑ |
| 9. ユーザー層 | +4 | -5 | **-1** | 0 |
| 10. プロジェクト全体設計 | +27 | -8 | **+19** | +9 ↑ |
| **合計** | **+199** | **-83** | **+116点** | **+61点 ↑** |

---

## 判定

**AlchemyEngine の総合スコアは +116点（前回 +55点 → +61点改善）。**

前回評価から 1 日で +61点という大幅改善は、改善計画が正確に優先度付けされ、実行されたことを示している。

### 今回の改善で解決された問題

| 前回の問題 | 解決状況 |
|:---|:---:|
| `game_network.ex` が完全な空スタブ（-5） | ✅ 完全実装済み |
| CI/CD パイプラインが存在しない（-4） | ✅ GitHub Actions 5 ジョブ追加 |
| `GameEvents` が 697 行・複数責務（-3） | ✅ 426行に削減・ディスパッチ専用化 |
| NIF 内 `unwrap()` / `expect()` が BEAM VM をクラッシュさせうる（-3） | ✅ 除去済み |
| Rust → Elixir メールボックスへのバックプレッシャーがない（-3） | ✅ IP-04 実装済み |
| ヘッドレス/オフスクリーンレンダリングモードがない（-3） | ✅ IP-05 実装済み |

### 残る主要課題（+116点 → +140点以上にするための優先アクション）

1. **`GameEvents` / `SceneManager` / `EventBus` のテスト追加**（推定 +8点）
   - `game_engine` アプリのテストカバレッジが事実上ゼロ
   - バックプレッシャー機構の動作テストも必要

2. **`LevelComponent` のアイテムドロップ重複バグ修正**（推定 +4点）
   - `on_event({:entity_removed, ...})` と `on_frame_event({:enemy_killed, ...})` の両方でドロップが発生する潜在バグ
   - `-3点` のバグが修正されれば `+1点` 加算

3. **複数ルームの実動作実証**（推定 +3点）
   - `GameServer.Application` で 2 ルームを起動し、OTP 隔離を実際の `GameEvents` プロセスで検証

4. **描画層の技術的負債解消**（推定 +4点）
   - 毎フレーム `Vec` アロケーション → `Renderer` フィールドに移動
   - UV マジックナンバー → `assets/atlas.toml` データファイル化

5. **NIF バージョニング・`create_world()` エラーハンドリング**（推定 +3点）
   - 起動時の NIF ABI 互換性チェック
   - `create_world()` の `NifResult` 対応

---

*プラス点の詳細: `docs/evaluation/specific-strengths.md`*
*マイナス点の詳細: `docs/evaluation/specific-weaknesses.md`*
*改善提案書: `docs/task/improvement-plan.md`*
